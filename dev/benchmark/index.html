<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Benchmarking · cuNumeric.jl</title><meta name="title" content="Benchmarking · cuNumeric.jl"/><meta property="og:title" content="Benchmarking · cuNumeric.jl"/><meta property="twitter:title" content="Benchmarking · cuNumeric.jl"/><meta name="description" content="Documentation for cuNumeric.jl."/><meta property="og:description" content="Documentation for cuNumeric.jl."/><meta property="twitter:description" content="Documentation for cuNumeric.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">cuNumeric.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../examples/">Examples</a></li><li><a class="tocitem" href="../perf/">Performance Tips</a></li><li><a class="tocitem" href="../usage/">Back End Details</a></li><li class="is-active"><a class="tocitem" href>Benchmarking</a><ul class="internal"><li><a class="tocitem" href="#Weak-Scaling-of-SGEMM"><span>Weak Scaling of SGEMM</span></a></li></ul></li><li><a class="tocitem" href="../api/">Public API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Benchmarking</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Benchmarking</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/ejmeitz/cuNumeric.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/ejmeitz/cuNumeric.jl/blob/main/pkg/docs/src/benchmark.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Benchmarking-cuNumeric.jl-Programs"><a class="docs-heading-anchor" href="#Benchmarking-cuNumeric.jl-Programs">Benchmarking cuNumeric.jl Programs</a><a id="Benchmarking-cuNumeric.jl-Programs-1"></a><a class="docs-heading-anchor-permalink" href="#Benchmarking-cuNumeric.jl-Programs" title="Permalink"></a></h1><p>Since there is no programatic way to set the hardware configuration (as of 24.11) benchmarking cuNumeric.jl code is a bit tedious. As an introduction, we walk through a benchmark of matrix multiplication (SGEMM). All the code for this benchmark can be found in the <code>cuNumeric.jl/pkg/benchmark</code> directory.</p><h2 id="Weak-Scaling-of-SGEMM"><a class="docs-heading-anchor" href="#Weak-Scaling-of-SGEMM">Weak Scaling of SGEMM</a><a id="Weak-Scaling-of-SGEMM-1"></a><a class="docs-heading-anchor-permalink" href="#Weak-Scaling-of-SGEMM" title="Permalink"></a></h2><p>In this benchmark we will try to understand the weak scaling behavior of the SGEMM kernel (Float32 MatMul). To get started we need to decide our initial problem size, <code>N</code> and create some arrays. Note depending on the choice of <code>N</code>, Legate may decide to schedule your tasks on the CPU or GPU or both. We will also define two functions, <code>total_flops</code> and <code>total_space</code> which will help us calculate some useful benchmark metrics.</p><pre><code class="language-julia hljs">using cuNumeric

N = 10_000

function initialize_cunumeric(N)
    A = cuNumeric.as_type(cuNumeric.rand(NDArray, N,N), LegateType(Float32))
    B = cuNumeric.as_type(cuNumeric.rand(NDArray, N,N), LegateType(Float32))
    C = cuNumeric.zeros(Float32, N, N)
    return A, B, C
end

function total_flops(N)
    return N * N * ((2*N) - 1)
end

function total_space(N)
    return 3 * (N^2) * sizeof(Float32)
end</code></pre><p>We cannot use rely on common benchmark tools in Julia like <a href="https://github.com/JuliaCI/BenchmarkTools.jl">BenchmarkTools.jl</a> or <a href="https://github.com/LilithHafner/Chairmarks.jl">ChairMarks.jl</a> or even the built in <code>Base.@time</code> macro. The asynchronous nature of operations on NDArrays means that function calls will execute almost immediately and program execution must be blocked to properly time a kernel. It is technically possible to time NDArray operations with something like <a href="https://github.com/JuliaCI/BenchmarkTools.jl">BenchmarkTools.jl</a> by adding a blocking operation (e.g., accessing the result), but the allocations reported by these tools will never be correct and it is safer to use the timing functionality from CuPyNumeric. </p><p>The timer built into CuPyNumeric blocks execution until all Legate operations preceding the call that generated the timing object complete. We provide two timing utilities: <code>get_time_microseconds</code> and <code>get_time_nanoseconds</code>. </p><p>Now we can write the benchmark code. There are two more parameters we need to set: the number of samples, <code>n_samples</code>, and the number of warm-up samples, <code>n_warnup</code>. With all this the benchmark loop is:</p><pre><code class="language-julia hljs">using LinearAlgebra 

function gemm_cunumeric(N, n_samples, n_warmup)
  A,B,C = initialize_cunumeric(N)

  start_time = nothing
  for idx in range(1, n_samples + n_warmup)
    # Don&#39;t start the timer until warm-up is done
    if idx == warmup + 1
        start_time = get_time_microseconds()
    end
  
    mul!(C, A, B)
        
  end
  total_time_μs = get_time_microseconds() - start_time
  mean_time_ms = total_time_μs / (n_samples * 1e3)
  gflops = total_flops(N) / (mean_time_ms * 1e6) # GFLOP is 1e9

  return mean_time_ms, gflops
end

n_samples = 10
n_warmup = 2

mean_time_ms, gflops = gemm_cunumeric(N, n_samples, n_warmup)</code></pre><p>Since there is no programatic way to set the hardware configuration we must manipulate the environment variables described in <a href="../usage/#Setting-Hardware-Configuration">Setting Hardware Configuration</a> through shell scripts to make a weak scaling plot. These variables must be set before we launch the Julia runtime where we will run our benchmark. Therefore, I do not recommend generating scaling plots from the REPL because you would have to start and stop the REPL each time to re-configure the hardware settings. To make benchmarking easier, we provide a small shell script, <code>run_benchmark.sh</code>, located in <code>cuNumeric.jl/pkg/benchmark</code>. This script will automatically set the <code>LEGATE_CONFIG</code> according to the passed flags and run the specified benchmark file.</p><p>The first time using this script it is important to set the memory configuration which is currently hard coded in <code>run_benchmark.sh</code> where <code>LEGATE_CONFIG</code> is exported. We recommend using the memory configuration which is automatically chosen by Legate. It is also important to note that <code>run_benchmark.sh</code> assumes the environment containing cuNumeric.jl is at the relative path <code>..</code> as hardcoded in the variable <code>CMD</code> (this is correct if you did not move files around). If your cuNumeric.jl environment is different be sure to update the path in <code>run_benchmark.sh</code>.</p><p>We have placed the SGEMM example from above into a Julia file called <code>sgemm.jl</code> located in the <code>cuNumeric.jl/pkg/benchmark</code> directory. Your cuNumeric environment can also be set by adding the following to <code>sgemm.jl</code>:</p><pre><code class="language-julia hljs">using Pkg
Pkg.activate(&quot;&lt;path-to-cunumeric-env&gt;&quot;)</code></pre><p>We also added the three lines to parse our settings from the command line so that we do not have to open the file to edit the settings each time.</p><pre><code class="language-julia hljs">N = parse(Int, ARGS[1])
n_samples = parse(Int, ARGS[2])
n_warmup = parse(Int, ARGS[3])</code></pre><p>To run the benchmark simply run the following command with your settings.</p><pre><code class="language-sh hljs">./run_benchmark.sh sgemm.jl --cpus &lt;n-cpus&gt; --gpus &lt;n-gpus&gt; &lt;N&gt; &lt;n_samples&gt; &lt;n_warmup&gt;</code></pre><p>Successful completion of one run should look like:</p><pre><code class="language-bash hljs">./run_benchmark.sh sgemm.jl --cpus 1 --gpus 1 10000 10 2
Running sgemm.jl with 1 CPUs and 1 GPUs
Running: julia --project=&#39;..&#39; sgemm.jl 10000 10 2
[ Info: Starting Legate
Legate hardware configuration: --cpus=1 --gpus=1 --omps=1 --ompthreads=3 --utility=2 --sysmem=256 --numamem=19029 --fbmem=7569 --zcmem=128 --regmem=0
[ Info: Started Legate successfully
[ Info: Running MATMUL benchmark on 10000x10000 matricies for 10 iterations, 2 warmups
cuNumeric Mean Run Time: 310.1302 ms
cuNumeric FLOPS: 6448.581918175012 GFLOPS
[ Info: Cleaning Up Legate</code></pre><p>To generate a weak scaling plot, you must increment the problem size in proportion to the number of GPUs. This helps reveal any communication overhead in our SGEMM implementation since data may be transfered between GPUs or even across nodes in a server.</p><p>OUR RESULTS COMING SOON</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../usage/">« Back End Details</a><a class="docs-footer-nextpage" href="../api/">Public API »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Wednesday 5 February 2025 06:47">Wednesday 5 February 2025</span>. Using Julia version 1.11.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
